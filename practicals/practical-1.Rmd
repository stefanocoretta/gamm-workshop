---
title: "Introduction to GAMs - Practical 1"
author: "Stefano Coretta"
date: "21/07/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
theme_set(theme_minimal())
library(mgcv)
library(itsadug)
library(tidymv)
```

```{r simulate-data}
set.seed(2018)
n <- 500
x <- 1:n
y <- 3 * log(x) + 10 + rnorm(n, 0, 1)
x_1 <- 1:n
y_1 <- 3 * log(x) + 4 + rnorm(n, 0, 1)

sim_data <- tibble(
  speech_rate = c(x, x_1),
  F0 = c(y, y_1),
  focus = rep(c("focus", "non-focus"), each = n)
)
```

# Simlated dataset: Speech rate and fundamental frequency (F0)

We will start by fitting a simple GAM to a big(ish) dataset (*n* = 1000). This dataset includes measurements of speech rate and fundamental frequency (F0). We want to know what is the relationship between speech rate and F0. The fictional experiment also included two focus conditions: focus and non-focus. So we are particularly interested in weather the condition `focus` has an effect on the relationship between speech rate and F0.

For this practical, we will build other model incrementally for pedagogical purpuses. In real life applications, you will prepare the data for fitting and start from a model with all of the terms you think are necessary.

# Fit a simple GAM

Let's first have a look at the data.

```{r plot-data}
sim_data %>%
  ggplot(aes(speech_rate, F0)) +
  geom_point(alpha = 0.7)
```

There is a clear non-linear relationship between speech rate and F0: when speech rate increases, F0 increases too, but at faster speech rates the increase in F0 is smaller. (Also, we can see a separation between two groups in the data, we will deal with this later)

We can model this non-linear increase in F0 using a GAM.

```{r F0-gam}
F0_gam <- gam(
  # the outcome variable: F0
  F0 ~
    # a smooth for speech rate
    s(speech_rate, bs = "ts", k = 10),
  # the data
  data = sim_data
)
summary(F0_gam)
```

Refresher:
* `s()` defines a smooth (a curve) over a variable, in this case `speech_rate`
* `bs` is used to select the type of *basis*
    * `ts` is a thin plate regression spline
* `k` is the number of *knots* (= number of basis functions + 1)

Let's plot the model!

```{r plot-F0-gam}
plot(F0_gam)
```

Now go back to the chunk `F0-gam` and try different bases (`bs`, the default is `tp`, try for example `cr` and `ps`) and different values of `k` (remember that the default is 10, try lower values).

# Compare focus vs. non-focus

What we are really interested in is to compare the effect of speech rate on F0 in the two focus conditions: focus and non-focus. We can do this by setting up a model using a `by` variable with an ordered factor. Remember that to use a `by` variable we need to create an ordered factor and change the contrasts to treatment.

```{r ordered}
sim_data <- sim_data %>%
  mutate(
    focus_o = ordered(focus, levels = c("non-focus", "focus"))
  )
contrasts(sim_data$focus_o) <- "contr.treatment" 
```

We can now fit a GAM using a smooth with a `by` variable. To do so, we need to add `focus` as a parametric term, include a smooth without the `by` variable (the reference smooth) and one with it (the difference smooth).

```{r focus-gam}
focus_gam <- gam(
  # the outcome variable: F0
  F0 ~
    # the parametric term
    focus_o +
    # the reference smooth
    s(speech_rate, bs = "tp", k = 10) +
    # the difference smooth
    s(speech_rate, by = focus_o, bs = "tp", k = 10),
  # the data
  data = sim_data,
  method = "ML"
)
summary(focus_gam)
```

To test for significance, we fit a null model and compare this model with the full model using `compareML()`.
The null model must exclude *both* the parametric term and the difference smooth.

```{r compare-focus-gam}
focus_gam_null <- gam(
  F0 ~
    s(speech_rate, bs = "tp", k = 10),
  data = sim_data,
  method = "ML"
)
compareML(focus_gam_null, focus_gam)
```

You can report the results from the model comparison like so: 
